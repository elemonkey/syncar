#!/bin/bash

# ===== DEPLOY SEGURO LOCAL - SYNCAR 2.0 =====
# Este script despliega en producci√≥n SIN afectar el entorno de desarrollo
# - Cierra puertos necesarios (80, 5555)
# - Limpia im√°genes y vol√∫menes antiguos
# - Reinicia servicios completamente
# - Preserva datos de desarrollo

set -e  # Exit on error

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

clear
echo "üöÄ ===== DEPLOY COMPLETO - SYNCAR 2.0 ====="
echo ""

# Verificar directorio
if [ ! -f "docker-compose.prod.yml" ]; then
    echo -e "${RED}‚ùå Error: docker-compose.prod.yml no encontrado${NC}"
    echo "Ejecuta este script desde la ra√≠z del proyecto"
    exit 1
fi

# Verificar que Docker est√© corriendo
if ! docker info > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Error: Docker no est√° corriendo${NC}"
    echo "Inicia Docker Desktop y vuelve a intentar"
    exit 1
fi

# Mostrar estado actual
echo -e "${BLUE}üìä Estado actual del sistema:${NC}"
echo ""
echo "Contenedores corriendo:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAME|importapp" || echo "  (ninguno)"
echo ""

# Advertencia
echo -e "${YELLOW}‚ö†Ô∏è  ESTE DEPLOY HAR√Å:${NC}"
echo "  ‚úÖ Liberar puertos 80, 5555 (cerrar procesos si es necesario)"
echo "  ‚úÖ Detener frontend dev (puerto 3000) temporalmente"
echo "  ‚úÖ Mantener backend dev corriendo (puerto 8000)"
echo "  ‚úÖ Mantener PostgreSQL dev (puerto 5432)"
echo "  ‚úÖ Mantener Redis dev (puerto 6379)"
echo "  ‚úÖ Eliminar im√°genes antiguas de producci√≥n"
echo "  ‚úÖ Eliminar vol√∫menes no utilizados (NO los de dev)"
echo "  ‚úÖ Construir im√°genes nuevas desde cero"
echo "  ‚úÖ Crear contenedores de producci√≥n (puerto 80, 5555)"
echo ""
read -p "¬øContinuar con el deploy? (y/N): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Deploy cancelado"
    exit 0
fi

# ===== PASO 1: CERRAR PUERTOS =====
echo ""
echo -e "${MAGENTA}üîí PASO 1/8: Liberando puertos necesarios...${NC}"

# Liberar puerto 80
echo -e "${BLUE}Verificando puerto 80...${NC}"
PORT_80_PID=$(lsof -ti:80 2>/dev/null || echo "")
if [ ! -z "$PORT_80_PID" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Proceso en puerto 80 (PID: $PORT_80_PID)${NC}"
    ps -p $PORT_80_PID -o comm= 2>/dev/null || echo "  (proceso desconocido)"
    echo "Cerrando proceso..."
    sudo kill -9 $PORT_80_PID 2>/dev/null || true
    sleep 1
    echo -e "${GREEN}‚úÖ Puerto 80 liberado${NC}"
else
    echo -e "${GREEN}‚úÖ Puerto 80 disponible${NC}"
fi

# Liberar puerto 5555 (Flower)
echo -e "${BLUE}Verificando puerto 5555...${NC}"
PORT_5555_PID=$(lsof -ti:5555 2>/dev/null || echo "")
if [ ! -z "$PORT_5555_PID" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Proceso en puerto 5555 (PID: $PORT_5555_PID)${NC}"
    echo "Cerrando proceso..."
    sudo kill -9 $PORT_5555_PID 2>/dev/null || true
    sleep 1
    echo -e "${GREEN}‚úÖ Puerto 5555 liberado${NC}"
else
    echo -e "${GREEN}‚úÖ Puerto 5555 disponible${NC}"
fi

# Detener frontend dev si est√° corriendo (puerto 3000)
echo -e "${BLUE}Verificando frontend dev (puerto 3000)...${NC}"
PORT_3000_PID=$(lsof -ti:3000 2>/dev/null || echo "")
if [ ! -z "$PORT_3000_PID" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Frontend dev corriendo (PID: $PORT_3000_PID)${NC}"
    echo "Deteniendo temporalmente..."
    kill $PORT_3000_PID 2>/dev/null || true
    sleep 2
    echo -e "${GREEN}‚úÖ Frontend dev detenido (podr√°s reiniciarlo despu√©s)${NC}"
else
    echo -e "${GREEN}‚úÖ Puerto 3000 disponible${NC}"
fi

# Verificar .env
if [ ! -f ".env" ]; then
    echo -e "${YELLOW}üìù Archivo .env no encontrado. Creando desde .env.example...${NC}"
    if [ -f ".env.example" ]; then
        cp .env.example .env
        echo -e "${GREEN}‚úÖ Archivo .env creado${NC}"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  EDITA .env antes de continuar:${NC}"
        echo "  - POSTGRES_PASSWORD"
        echo "  - SECRET_KEY"
        echo "  - Otras variables necesarias"
        echo ""
        read -p "Presiona ENTER cuando hayas editado .env..."
    else
        echo -e "${RED}‚ùå Error: .env.example no encontrado${NC}"
        exit 1
    fi
fi

# ===== PASO 2: BACKUP =====
echo ""
echo -e "${MAGENTA}ÔøΩ PASO 2/8: Creando backup de base de datos...${NC}"
mkdir -p backups

if docker ps | grep -q "importapp-postgres"; then
    BACKUP_FILE="backups/backup_$(date +%Y%m%d_%H%M%S).sql"
    echo "Creando backup en $BACKUP_FILE..."
    docker exec importapp-postgres pg_dump -U syncar_user syncar_prod > "$BACKUP_FILE" 2>/dev/null || true
    if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
        echo -e "${GREEN}‚úÖ Backup creado: $BACKUP_FILE ($(du -h "$BACKUP_FILE" | cut -f1))${NC}"
    else
        rm -f "$BACKUP_FILE"
        echo -e "${YELLOW}‚ö†Ô∏è  No se pudo crear backup (posiblemente no hay datos)${NC}"
    fi
else
    echo -e "${YELLOW}‚ÑπÔ∏è  No hay contenedor de producci√≥n existente${NC}"
fi

# ===== PASO 3: DETENER CONTENEDORES =====
echo ""
echo -e "${MAGENTA}üõë PASO 3/8: Deteniendo contenedores de producci√≥n...${NC}"
if docker-compose -f docker-compose.prod.yml ps -q 2>/dev/null | grep -q .; then
    echo "Deteniendo servicios..."
    docker-compose -f docker-compose.prod.yml down -v 2>/dev/null || true
    echo -e "${GREEN}‚úÖ Contenedores detenidos${NC}"
else
    echo -e "${GREEN}‚úÖ No hay contenedores de producci√≥n corriendo${NC}"
fi

# ===== PASO 4: LIMPIAR IM√ÅGENES Y VOL√öMENES =====
echo ""
echo -e "${MAGENTA}üßπ PASO 4/8: Limpiando im√°genes y vol√∫menes antiguos...${NC}"

# Eliminar im√°genes de producci√≥n antiguas
echo "Eliminando im√°genes antiguas de importapp..."
docker images | grep "importapp\|syncar2.0" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
echo -e "${GREEN}‚úÖ Im√°genes antiguas eliminadas${NC}"

# Limpiar vol√∫menes no utilizados (excepto los de dev)
echo "Limpiando vol√∫menes no utilizados..."
VOLUMES_REMOVED=$(docker volume ls -qf dangling=true | grep -v "syncar20-postgres-dev-data\|syncar20-redis-dev-data" | xargs -r docker volume rm 2>/dev/null | wc -l || echo "0")
if [ "$VOLUMES_REMOVED" -gt 0 ]; then
    echo -e "${GREEN}‚úÖ $VOLUMES_REMOVED vol√∫menes eliminados${NC}"
else
    echo -e "${GREEN}‚úÖ No hay vol√∫menes para eliminar${NC}"
fi

# Limpiar cache de build
echo "Limpiando cache de build de Docker..."
docker builder prune -f > /dev/null 2>&1 || true
echo -e "${GREEN}‚úÖ Cache de build limpiado${NC}"

# ===== PASO 5: VERIFICAR SERVICIOS DEV =====
echo ""
echo -e "${MAGENTA}üîç PASO 5/8: Verificando servicios de desarrollo...${NC}"

# Verificar PostgreSQL dev
if docker ps | grep -q "importapp-postgres-dev"; then
    echo -e "${GREEN}‚úÖ PostgreSQL dev corriendo (puerto 5432)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  PostgreSQL dev no est√° corriendo${NC}"
    echo "   Iniciando PostgreSQL dev..."
    docker-compose -f docker-compose.dev.yml up -d postgres 2>/dev/null || true
    sleep 3
    echo -e "${GREEN}‚úÖ PostgreSQL dev iniciado${NC}"
fi

# Verificar Redis dev
if docker ps | grep -q "importapp-redis-dev"; then
    echo -e "${GREEN}‚úÖ Redis dev corriendo (puerto 6379)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Redis dev no est√° corriendo${NC}"
    echo "   Iniciando Redis dev..."
    docker-compose -f docker-compose.dev.yml up -d redis 2>/dev/null || true
    sleep 2
    echo -e "${GREEN}‚úÖ Redis dev iniciado${NC}"
fi

# ===== PASO 6: CONSTRUIR IM√ÅGENES =====
echo ""
echo -e "${MAGENTA}üî® PASO 6/8: Construyendo im√°genes Docker desde cero...${NC}"
echo "Esto puede tomar varios minutos..."
docker-compose -f docker-compose.prod.yml build --no-cache --pull

echo -e "${GREEN}‚úÖ Im√°genes construidas${NC}"

# ===== PASO 7: INICIAR SERVICIOS =====
echo ""
echo -e "${MAGENTA}üöÄ PASO 7/8: Iniciando servicios de producci√≥n...${NC}"
docker-compose -f docker-compose.prod.yml up -d

# Esperar a que los servicios est√©n listos
echo ""
echo -e "${BLUE}‚è≥ Esperando a que los servicios inicien...${NC}"
for i in {1..30}; do
    echo -n "."
    sleep 1
done
echo ""

# Verificar que todos los servicios est√©n corriendo
echo ""
echo -e "${BLUE}ÔøΩ Verificando servicios...${NC}"
EXPECTED_SERVICES=8
RUNNING_SERVICES=$(docker-compose -f docker-compose.prod.yml ps --services --filter "status=running" | wc -l)

if [ "$RUNNING_SERVICES" -eq "$EXPECTED_SERVICES" ]; then
    echo -e "${GREEN}‚úÖ Todos los servicios est√°n corriendo ($RUNNING_SERVICES/$EXPECTED_SERVICES)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Solo $RUNNING_SERVICES de $EXPECTED_SERVICES servicios est√°n corriendo${NC}"
    echo "Servicios:"
    docker-compose -f docker-compose.prod.yml ps
fi

# ===== PASO 8: MIGRACIONES =====
echo ""
echo -e "${MAGENTA}üîÑ PASO 8/8: Ejecutando migraciones de base de datos...${NC}"
sleep 5  # Esperar un poco m√°s para que postgres est√© listo

# Intentar migraciones hasta 3 veces
MAX_RETRIES=3
RETRY_COUNT=0
MIGRATION_SUCCESS=false

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if docker exec importapp-backend alembic upgrade head 2>/dev/null; then
        echo -e "${GREEN}‚úÖ Migraciones ejecutadas exitosamente${NC}"
        MIGRATION_SUCCESS=true
        break
    else
        RETRY_COUNT=$((RETRY_COUNT + 1))
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Intento $RETRY_COUNT fall√≥, reintentando en 5 segundos...${NC}"
            sleep 5
        fi
    fi
done

if [ "$MIGRATION_SUCCESS" = false ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Migraciones fallaron despu√©s de $MAX_RETRIES intentos${NC}"
    echo "   Esto puede ser normal en el primer deploy"
    echo "   Puedes ejecutarlas manualmente con:"
    echo "   docker exec importapp-backend alembic upgrade head"
fi

# ===== VERIFICACI√ìN FINAL =====
echo ""
echo -e "${MAGENTA}üîç Verificaci√≥n final...${NC}"

# Probar que el backend responde
echo -n "Verificando backend... "
if curl -s -o /dev/null -w "%{http_code}" http://localhost/api/docs | grep -q "200"; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  (puede tardar unos segundos en estar disponible)${NC}"
fi

# Probar que el frontend responde
echo -n "Verificando frontend... "
if curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200"; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  (puede tardar unos segundos en estar disponible)${NC}"
fi

# Probar que Flower responde
echo -n "Verificando Flower... "
if curl -s -o /dev/null -w "%{http_code}" http://localhost:5555 | grep -q "200"; then
    echo -e "${GREEN}‚úÖ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  (puede tardar unos segundos en estar disponible)${NC}"
fi

# ===== RESUMEN FINAL =====
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo -e "${GREEN}‚úÖ ===== DEPLOY COMPLETADO EXITOSAMENTE ===== ${NC}"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo -e "${BLUE}üåê URLs de la aplicaci√≥n:${NC}"
echo "   Frontend:    http://localhost"
echo "   Backend API: http://localhost/api/docs"
echo "   Flower:      http://localhost:5555"
echo ""
echo -e "${BLUE}üìä Comandos √∫tiles:${NC}"
echo "   Ver todos los logs:     docker-compose -f docker-compose.prod.yml logs -f"
echo "   Ver logs del backend:   docker-compose -f docker-compose.prod.yml logs -f backend"
echo "   Ver logs del frontend:  docker-compose -f docker-compose.prod.yml logs -f frontend"
echo "   Ver estado:             docker-compose -f docker-compose.prod.yml ps"
echo "   Reiniciar servicio:     docker-compose -f docker-compose.prod.yml restart <servicio>"
echo "   Detener todo:           docker-compose -f docker-compose.prod.yml down"
echo ""
echo -e "${BLUE}ÔøΩ Para restaurar entorno de desarrollo:${NC}"
echo "   1. docker-compose -f docker-compose.prod.yml down"
echo "   2. cd backend && source venv/bin/activate && uvicorn app.main:app --reload"
echo "   3. cd frontend && npm run dev"
echo ""
echo -e "${BLUE}üóÑÔ∏è  Base de datos:${NC}"
echo "   Conectar:  docker exec -it importapp-postgres psql -U syncar_user syncar_prod"
echo "   Backup en: backups/"
echo ""
echo -e "${BLUE}üì¶ Contenedores de producci√≥n:${NC}"
docker-compose -f docker-compose.prod.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
echo ""
echo -e "${GREEN}üéâ ¬°SYNCAR 2.0 est√° corriendo en producci√≥n!${NC}"
echo ""
echo -e "${YELLOW}üí° Tip: Espera 10-15 segundos para que todos los servicios est√©n 100% listos${NC}"
echo ""

# Preguntar si desea ver los logs
read -p "¬øDeseas ver los logs en tiempo real? (y/N): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    echo "Presiona Ctrl+C para salir de los logs"
    echo ""
    sleep 2
    docker-compose -f docker-compose.prod.yml logs -f
fi
